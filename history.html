<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì†”ë¼ëŸ¬ë‹í¬ë£¨ - íšŒì› ê¸°ë¡</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <aside>
        <div class="sidebar-header">
            <a href="index.html">ì†”ë¼ëŸ¬ë‹í¬ë£¨</a>
        </div>
        <nav>
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a href="records.html" class="nav-item">
                <span class="nav-icon">ğŸ“‹</span>
                <span>ê¸°ë¡ ë“±ë¡</span>
            </a>
            <a href="members.html" class="nav-item" id="nav-members" style="display: none;">
                <span class="nav-icon">ğŸ‘¤</span>
                <span>íšŒì› ê´€ë¦¬</span>
            </a>
            </nav>

    </aside>

    <main>
        <header>
            <h1>íšŒì› ê¸°ë¡ í†µê³„</h1>
            <div style="color: var(--text-muted); font-size: 0.85rem;" id="sync-status">ì‹¤ì‹œê°„ ì—°ë™ ì¤‘</div>
        </header>

        <div class="card">
            <h3 style="margin-bottom: 1.25rem;">ëˆ„ì  í™œë™ ë°ì´í„°</h3>
            <div style="overflow-x: auto; margin: 0 -0.75rem;">
                <table class="data-table" style="min-width: 550px; width: 100%;">
                    <thead>
                        <tr>
                            <th style="padding-left: 0.75rem; width: 80px;">ì´ë¦„</th>
                            <th style="width: 90px;">ì´ê±°ë¦¬</th>
                            <th style="width: 80px;">í˜ì´ìŠ¤</th>
                            <th style="width: 90px;">ì´ì‹œê°„</th>
                            <th style="width: 60px;">íšŸìˆ˜</th>
                            <th style="padding-right: 0.75rem; text-align: right;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="history-list">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-muted);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Popup Modal: Edit Most Recent Activity Log -->
    <div class="modal-overlay" id="edit-log-modal" onclick="window.handleOverlayClick(event)">
        <div class="modal">
            <div class="modal-header">
                <h3>ë§ˆì§€ë§‰ ê¸°ë¡ ìˆ˜ì •</h3>
                <button onclick="window.closeEditModal()" style="border:none; background:none; font-size: 1.75rem; cursor:pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="edit-target-info" style="margin-bottom: 1.25rem; padding: 1rem; background: #f8fafc; border-radius: 0.75rem; border: 1px solid #e2e8f0;">
                    <div style="font-size: 0.8rem; color: #64748b;">ìˆ˜ì • ëŒ€ìƒ íšŒì›</div>
                    <div style="font-size: 1.1rem; font-weight: 800; color: var(--primary-color);" id="edit-member-name-label">--</div>
                </div>
                <form id="log-edit-form">
                    <input type="hidden" id="edit-log-id">
                    <input type="hidden" id="edit-member-id">
                    <div class="form-group">
                        <label>ìš´ë™ ë‚ ì§œ</label>
                        <input type="date" id="edit-log-date" class="form-control">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>ê±°ë¦¬ (km)</label>
                            <input type="number" id="edit-log-distance" class="form-control" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>í˜ì´ìŠ¤</label>
                            <input type="text" id="edit-log-pace" class="form-control">
                        </div>
                    </div>
                    <div style="background: #fffbeb; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.75rem; color: #92400e; border: 1px solid #fde68a;">
                        â„¹ï¸ ë§ˆì§€ë§‰ ê¸°ë¡ì„ ìˆ˜ì •í•˜ë©´ íšŒì›ì˜ ì´ ëˆ„ê³„ ë°ì´í„°ë„ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ê³„ì‚°ë˜ì–´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="window.closeEditModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="window.saveLogEdit()">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- Popup Modal: Member Statistics (Same as members.html) -->
    <div class="modal-overlay" id="stats-modal-overlay" onclick="window.handleOverlayClick(event)">
        <div class="modal">
            <div class="modal-header">
                <h3>íšŒì› í™œë™ ê¸°ë¡</h3>
                <button onclick="window.closeStatsModal()" style="border:none; background:none; font-size: 1.75rem; cursor:pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="stats-member-info" style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 1.25rem; font-weight: 800; color: var(--text-main);" id="stats-member-name">--</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">í™œë™ ì´ë ¥ ë° í†µê³„</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="label">ì´ë²ˆ ë‹¬ ê±°ë¦¬</span>
                        <span class="value" id="monthly-dist">0.0k</span>
                    </div>
                    <div class="stat-box">
                        <span class="label">ìµœê·¼ 7ì¼ ê±°ë¦¬</span>
                        <span class="value" id="weekly-dist">0.0k</span>
                    </div>
                </div>
                <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.5rem;">ìµœê·¼ í™œë™ (ì£¼ì°¨ë³„ êµ¬ë¶„)</div>
                <div class="history-list" id="history-items"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="window.closeStatsModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- [ë³´ì•ˆ] ë¡œê·¸ì¸ ì²´í¬ ë° ë©”ë‰´ ì œì–´ ---
        const checkAuth = () => {
            const user = JSON.parse(localStorage.getItem('crew_user'));
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return null;
            }
            // ê´€ë¦¬ìì¼ ë•Œë§Œ íšŒì›ê´€ë¦¬ ë©”ë‰´ í‘œì‹œ
            if (user.role === 'admin') {
                const navMembers = document.getElementById('nav-members');
                if (navMembers) navMembers.style.display = 'flex';
            }
            return user;
        };
        const currentUser = checkAuth();
        if (!currentUser) throw new Error("Unauthorized");

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy, where, getDocs, limit } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1TE3jtcdcH6UvbfPGIy_IeaVivg2YvPA",
            authDomain: "run-app-268d5.firebaseapp.com",
            projectId: "run-app-268d5",
            storageBucket: "run-app-268d5.firebasestorage.app",
            messagingSenderId: "1064940196481",
            appId: "1:1064940196481:web:0408fd1fb557c4b2a2b380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const membersCol = collection(db, "members");
        const logsCol = collection(db, "activity_logs");

        // 1. ëˆ„ì  ë°ì´í„° ì‹¤ì‹œê°„ ë¡œë“œ
        onSnapshot(query(membersCol, orderBy("name")), (snapshot) => {
            const tbody = document.getElementById('history-list');
            const thead = document.querySelector('thead tr');
            tbody.innerHTML = '';
            
            // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ 'ê´€ë¦¬' í—¤ë” ìˆ¨ê¹€
            if (currentUser.role !== 'admin') {
                const manageHeader = thead.querySelector('th:last-child');
                if (manageHeader) manageHeader.style.display = 'none';
            }

            snapshot.forEach((docSnap) => {
                const m = docSnap.data();
                const tr = document.createElement('tr');
                
                const totalMinutes = m.totalTime || 0;
                const h = Math.floor(totalMinutes / 60);
                const min = Math.round(totalMinutes % 60);
                const timeStr = h > 0 ? `${h}ì‹œê°„ ${min}ë¶„` : `${min}ë¶„`;

                let rowHtml = `
                    <td style="padding-left: 0.75rem; font-weight: 700; color: var(--primary-color); cursor: pointer;" onclick="window.showStats('${docSnap.id}', '${m.name}')">${m.name}</td>
                    <td><span style="color: var(--text-main); font-weight: 800;">${m.distance || 0}</span> km</td>
                    <td><span style="font-family: monospace; font-size: 0.85rem;">${m.pace || "0'00\""}</span></td>
                    <td style="font-size: 0.85rem;">${timeStr}</td>
                    <td>${m.count || 0} íšŒ</td>
                `;

                // ê´€ë¦¬ìì¼ ë•Œë§Œ ìˆ˜ì • ë²„íŠ¼ ì¶”ê°€
                if (currentUser.role === 'admin') {
                    rowHtml += `
                        <td style="padding-right: 0.75rem; text-align: right;">
                            <button class="btn btn-outline btn-sm" style="padding: 0.4rem 0.6rem;" onclick="window.openLastLogEdit('${docSnap.id}', '${m.name}')">ìˆ˜ì •</button>
                        </td>
                    `;
                }

                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
            document.getElementById('sync-status').innerText = "ì‹¤ì‹œê°„ ì—°ë™ ì™„ë£Œ";
        });

        // 2. ë§ˆì§€ë§‰ ê¸°ë¡ ìˆ˜ì • íŒì—… ì—´ê¸°
        window.openLastLogEdit = async (memberId, memberName) => {
            document.getElementById('edit-member-name-label').innerText = memberName;
            document.getElementById('edit-member-id').value = memberId;

            try {
                // ì¸ë±ìŠ¤ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ orderByë¥¼ ì œê±°í•˜ê³  ëª¨ë“  ë¡œê·¸ë¥¼ ê°€ì ¸ì˜¨ í›„ JSì—ì„œ ì •ë ¬í•©ë‹ˆë‹¤.
                const q = query(logsCol, where("memberId", "==", memberId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    alert('ìˆ˜ì •í•  í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê¸°ë¡ì„ ë“±ë¡í•´ ì£¼ì„¸ìš”.');
                    return;
                }

                // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì¥ ë§ˆì§€ë§‰ ê¸°ë¡ ì¶”ì¶œ
                const logs = [];
                querySnapshot.forEach((doc) => {
                    logs.push({ id: doc.id, ...doc.data() });
                });
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                const lastLog = logs[0];

                document.getElementById('edit-log-id').value = lastLog.id;
                document.getElementById('edit-log-date').value = lastLog.date;
                document.getElementById('edit-log-distance').value = lastLog.distance;
                document.getElementById('edit-log-pace').value = lastLog.pace;

                const overlay = document.getElementById('edit-log-modal');
                overlay.style.display = 'flex';
                setTimeout(() => overlay.classList.add('active'), 10);
            } catch (e) {
                console.error("Fetch last log error:", e);
                alert('ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            }
        };

        // 3. ë§ˆì§€ë§‰ ê¸°ë¡ ì €ì¥ ë° ëˆ„ê³„ ì¬ê³„ì‚°
        window.saveLogEdit = async () => {
            const logId = document.getElementById('edit-log-id').value;
            const memberId = document.getElementById('edit-member-id').value;
            const newDist = parseFloat(document.getElementById('edit-log-distance').value);
            const newPace = document.getElementById('edit-log-pace').value;
            const newDate = document.getElementById('edit-log-date').value;

            try {
                // 1. ê°œë³„ ë¡œê·¸ ì—…ë°ì´íŠ¸
                await updateDoc(doc(db, "activity_logs", logId), {
                    distance: newDist,
                    pace: newPace,
                    date: newDate
                });

                // 2. í•´ë‹¹ íšŒì›ì˜ ëª¨ë“  ë¡œê·¸ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ì´ ëˆ„ê³„ ì¬ê³„ì‚° (ë°ì´í„° ì¼ê´€ì„± ìœ ì§€)
                const q = query(logsCol, where("memberId", "==", memberId));
                const allLogsSnapshot = await getDocs(q);
                
                let totalDist = 0;
                let totalCount = 0;
                let lastPace = newPace;

                allLogsSnapshot.forEach((l) => {
                    const data = l.data();
                    totalDist += data.distance;
                    totalCount += 1;
                });

                // 3. íšŒì› ë§ˆìŠ¤í„° ì •ë³´ ì—…ë°ì´íŠ¸
                await updateDoc(doc(db, "members", memberId), {
                    distance: Number(totalDist.toFixed(1)),
                    count: totalCount,
                    pace: lastPace // ê°€ì¥ ìµœê·¼ ìˆ˜ì •ëœ í˜ì´ìŠ¤ë¡œ ìœ ì§€
                });

                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ëˆ„ì  í†µê³„ê°€ ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.closeEditModal();
            } catch (e) {
                alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜: " + e.message);
            }
        };

        // --- íšŒì› í†µê³„ ë³´ê¸° (members.htmlê³¼ ë™ì¼ ë¡œì§) ---
        window.showStats = async (memberId, memberName) => {
            document.getElementById('stats-member-name').innerText = memberName;
            const historyContainer = document.getElementById('history-items');
            historyContainer.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted);">ë¶„ì„ ì¤‘...</div>';
            
            const overlay = document.getElementById('stats-modal-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);

            try {
                const q = query(logsCol, where("memberId", "==", memberId));
                const querySnapshot = await getDocs(q);
                
                let monthlyDist = 0; let weeklyDist = 0;
                const now = new Date();
                const oneMonthAgo = new Date(); oneMonthAgo.setMonth(now.getMonth() - 1);
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7);
                
                const logs = [];
                querySnapshot.forEach((docSnap) => logs.push(docSnap.data()));
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                historyContainer.innerHTML = '';
                logs.forEach((log) => {
                    const logDate = new Date(log.date);
                    if (logDate >= oneMonthAgo) monthlyDist += log.distance;
                    if (logDate >= oneWeekAgo) weeklyDist += log.distance;
                    const weekNum = getWeekNumber(logDate);
                    const weekClass = weekNum % 2 === 0 ? 'week-even' : 'week-odd';
                    const item = document.createElement('div');
                    item.className = `history-item ${weekClass}`;
                    item.innerHTML = `
                        <div class="date">${log.date}</div>
                        <div class="metrics"><span class="dist">${log.distance}km</span><div class="pace">${log.pace}</div></div>
                    `;
                    historyContainer.appendChild(item);
                });
                document.getElementById('monthly-dist').innerText = monthlyDist.toFixed(1) + "k";
                document.getElementById('weekly-dist').innerText = weeklyDist.toFixed(1) + "k";
            } catch (e) { console.error(e); }
        };

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        window.closeEditModal = () => {
            const overlay = document.getElementById('edit-log-modal');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        };

        window.closeStatsModal = () => {
            const overlay = document.getElementById('stats-modal-overlay');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        };

        window.handleOverlayClick = (e) => {
            if(e.target.classList.contains('modal-overlay')) {
                window.closeEditModal();
                window.closeStatsModal();
            }
        };
    </script>
</body>
</html>
