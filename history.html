<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì†”ë¼ëŸ¬ë‹í¬ë£¨ - íšŒì› ê¸°ë¡</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <aside>
        <div class="sidebar-header">
            <a href="index.html">ì†”ë¼ëŸ¬ë‹í¬ë£¨</a>
        </div>
        <nav>
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span><span>í™ˆ</span>
            </a>
            <a href="history.html" class="nav-item active">
                <span class="nav-icon">ğŸ“Š</span><span>íšŒì› ê¸°ë¡</span>
            </a>
            <a href="records.html" class="nav-item">
                <span class="nav-icon">ğŸ“‹</span><span>ê¸°ë¡ ë“±ë¡</span>
            </a>
            <a href="members.html" class="nav-item" id="nav-members" style="display: none;">
                <span class="nav-icon">ğŸ‘¤</span><span>íšŒì› ê´€ë¦¬</span>
            </a>
        </nav>
    </aside>

    <main>
        <header>
            <h1>íšŒì› ê¸°ë¡ í†µê³„</h1>
            <div style="color: var(--text-muted); font-size: 0.85rem;" id="sync-status">ì‹¤ì‹œê°„ ì—°ë™ ì¤‘</div>
        </header>

        <div class="card">
            <h3 style="margin-bottom: 1.25rem;">ëˆ„ì  í™œë™ ë°ì´í„°</h3>
            <div style="overflow-x: auto; margin: 0 -0.75rem;">
                <table class="data-table" style="min-width: 550px; width: 100%;">
                    <thead>
                        <tr>
                            <th style="padding-left: 0.75rem; width: 80px;">ì´ë¦„</th>
                            <th style="width: 90px;">ì´ê±°ë¦¬</th>
                            <th style="width: 80px;">í˜ì´ìŠ¤</th>
                            <th style="width: 90px;">ì´ì‹œê°„</th>
                            <th style="width: 60px;">íšŸìˆ˜</th>
                            <th style="padding-right: 0.75rem; text-align: right;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="history-list">
                        <tr><td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-muted);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 1. íšŒì› ìƒì„¸ í†µê³„ íŒì—… -->
    <div class="modal-overlay" id="stats-modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>íšŒì› í™œë™ ìƒì„¸</h3>
                <button onclick="window.closeStatsModal()" style="border:none; background:none; font-size: 1.75rem; cursor:pointer; color: var(--text-muted);">&times;</button>
            </div>
            <div class="modal-body">
                <div id="stats-member-info" style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 1.3rem; font-weight: 800; color: var(--primary-color);" id="stats-member-name">--</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">ì „ì²´ í™œë™ íˆìŠ¤í† ë¦¬</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="label">ì´ë²ˆ ë‹¬ ê±°ë¦¬</span>
                        <span class="value" id="monthly-dist">0.0k</span>
                    </div>
                    <div class="stat-box">
                        <span class="label">ìµœê·¼ 7ì¼ ê±°ë¦¬</span>
                        <span class="value" id="weekly-dist">0.0k</span>
                    </div>
                </div>
                <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 5px;">
                    ğŸ“… ìµœê·¼ í™œë™ <small style="font-weight:400; color:var(--text-muted);">(ì£¼ì°¨ë³„ êµ¬ë¶„)</small>
                </div>
                <div class="history-list" id="history-items">
                    <!-- í™œë™ ì´ë ¥ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë¨ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" style="width: 100%;" onclick="window.closeStatsModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- 2. ê°œë³„ í™œë™ ê¸°ë¡ ìˆ˜ì • íŒì—… (ê¸°ë¡ ë“±ë¡ ì¹´ë“œì™€ ë™ì¼ ìŠ¤íƒ€ì¼) -->
    <div class="modal-overlay" id="edit-specific-log-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>ëŸ°ë‹ ê¸°ë¡ ìˆ˜ì •</h3>
                <button onclick="window.closeSpecificEditModal()" style="border:none; background:none; font-size: 1.75rem; cursor:pointer; color: var(--text-muted);">&times;</button>
            </div>
            <div class="modal-body">
                <form id="specific-log-form" onsubmit="event.preventDefault();">
                    <input type="hidden" id="spec-log-id">
                    <input type="hidden" id="spec-member-id">
                    <div class="form-group">
                        <label>ìš´ë™ ë‚ ì§œ</label>
                        <input type="date" id="spec-date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>ëŸ¬ë‹ ì¥ì†Œ</label>
                        <select id="spec-location" class="form-control">
                            <option value="ì‹¤ì™¸">ì‹¤ì™¸ (Outdoor)</option>
                            <option value="ì‹¤ë‚´">ì‹¤ë‚´ (Indoor)</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>ëŸ¬ë‹ ê±°ë¦¬ (km)</label>
                            <input type="number" id="spec-distance" class="form-control" placeholder="0.0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>í˜ì´ìŠ¤</label>
                            <input type="text" id="spec-pace" class="form-control" placeholder="5'30\"">
                        </div>
                    </div>
                    <p style="font-size: 0.75rem; color: #6366f1; background: #f5f3ff; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #ddd6fe;">
                        ğŸ’¡ ê¸°ë¡ì„ ìˆ˜ì •í•˜ë©´ í•´ë‹¹ íšŒì›ì˜ ì´ ëˆ„ì  ê±°ë¦¬ì™€ íšŸìˆ˜ê°€ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ê³„ì‚°ë©ë‹ˆë‹¤.
                    </p>
                </form>
            </div>
            <div class="modal-footer" style="display: flex; gap: 0.75rem;">
                <button class="btn btn-outline" onclick="window.closeSpecificEditModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="window.saveSpecificLogEdit()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // [ë³´ì•ˆ] ë¡œê·¸ì¸ ë° ë©”ë‰´ ê¶Œí•œ ì²´í¬
        const checkAuth = () => {
            const user = JSON.parse(localStorage.getItem('crew_user'));
            if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); window.location.href = 'index.html'; return null; }
            if (user.role === 'admin') {
                const navMembers = document.getElementById('nav-members');
                if (navMembers) navMembers.style.display = 'flex';
            }
            return user;
        };
        const currentUser = checkAuth();
        if (!currentUser) throw new Error("Unauthorized");

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, where, getDocs } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1TE3jtcdcH6UvbfPGIy_IeaVivg2YvPA",
            authDomain: "run-app-268d5.firebaseapp.com",
            projectId: "run-app-268d5",
            storageBucket: "run-app-268d5.firebasestorage.app",
            messagingSenderId: "1064940196481",
            appId: "1:1064940196481:web:0408fd1fb557c4b2a2b380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const membersCol = collection(db, "members");
        const logsCol = collection(db, "activity_logs");

        // 1. ì‹¤ì‹œê°„ ëˆ„ê³„ ë°ì´í„° ë Œë”ë§
        onSnapshot(query(membersCol, orderBy("name")), (snapshot) => {
            const tbody = document.getElementById('history-list');
            const thead = document.querySelector('thead tr');
            tbody.innerHTML = '';
            
            if (currentUser.role !== 'admin') {
                const manageHeader = thead.querySelector('th:last-child');
                if (manageHeader) manageHeader.style.display = 'none';
            }

            snapshot.forEach((docSnap) => {
                const m = docSnap.data();
                const totalMinutes = m.totalTime || 0;
                const h = Math.floor(totalMinutes / 60);
                const min = Math.round(totalMinutes % 60);
                const timeStr = h > 0 ? `${h}ì‹œê°„ ${min}ë¶„` : `${min}ë¶„`;

                const tr = document.createElement('tr');
                let rowHtml = `
                    <td style="padding-left: 0.75rem; font-weight: 700; color: var(--primary-color); cursor: pointer;" onclick="window.showStats('${docSnap.id}', '${m.name}')">${m.name}</td>
                    <td><span style="color: var(--text-main); font-weight: 800;">${m.distance || 0}</span> km</td>
                    <td><span style="font-family: monospace; font-size: 0.85rem;">${m.pace || "0'00\""}</span></td>
                    <td style="font-size: 0.85rem;">${timeStr}</td>
                    <td>${m.count || 0} íšŒ</td>
                `;

                if (currentUser.role === 'admin') {
                    rowHtml += `
                        <td style="padding-right: 0.75rem; text-align: right;">
                            <span style="color:var(--text-muted); font-size:0.75rem;">(ìƒì„¸ì—ì„œ ìˆ˜ì •)</span>
                        </td>
                    `;
                }
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
            document.getElementById('sync-status').innerText = "ì‹¤ì‹œê°„ ì—°ë™ ì™„ë£Œ";
        });

        // 2. íšŒì› ìƒì„¸ í†µê³„ íŒì—… ì—´ê¸°
        window.showStats = async (memberId, memberName) => {
            document.getElementById('stats-member-name').innerText = memberName;
            const historyContainer = document.getElementById('history-items');
            historyContainer.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-muted);">í™œë™ ë‚´ì—­ ë¡œë”© ì¤‘...</div>';
            
            const overlay = document.getElementById('stats-modal-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);

            try {
                const q = query(logsCol, where("memberId", "==", memberId));
                const querySnapshot = await getDocs(q);
                
                let monthlyDist = 0; let weeklyDist = 0;
                const now = new Date();
                const oneMonthAgo = new Date(); oneMonthAgo.setMonth(now.getMonth() - 1);
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7);
                
                const logs = [];
                querySnapshot.forEach((d) => logs.push({ id: d.id, ...d.data() }));
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                historyContainer.innerHTML = '';
                if(logs.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-muted);">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }

                logs.forEach((log) => {
                    const logDate = new Date(log.date);
                    if (logDate >= oneMonthAgo) monthlyDist += (log.distance || 0);
                    if (logDate >= oneWeekAgo) weeklyDist += (log.distance || 0);
                    
                    const weekNum = getWeekNumber(logDate);
                    const weekClass = weekNum % 2 === 0 ? 'week-even' : 'week-odd';
                    
                    const item = document.createElement('div');
                    item.className = `history-item ${weekClass}`;
                    item.style.flexDirection = 'column';
                    item.style.alignItems = 'flex-start';

                    let actionsHtml = '';
                    if (currentUser.role === 'admin') {
                        actionsHtml = `
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; width: 100%;">
                                <button class="btn btn-danger btn-sm" style="flex: 1; min-height: 48px; font-size: 1rem;" onclick="window.deleteSpecificLog('${log.id}', '${memberId}')">ì‚­ì œ</button>
                            </div>
                        `;
                    }

                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                            <div class="date" style="font-size: 1rem;">${log.date} <small style="color:#64748b;">[${log.location || 'ì‹¤ì™¸'}]</small></div>
                            <div class="metrics" style="text-align: right;">
                                <span class="dist" style="display:block; font-size: 1.1rem; font-weight: 800;">${log.distance}km</span>
                                <div class="pace" style="font-size: 0.85rem;">${log.pace}</div>
                            </div>
                        </div>
                        ${actionsHtml}
                    `;
                    historyContainer.appendChild(item);
                });

                document.getElementById('monthly-dist').innerText = monthlyDist.toFixed(1) + "k";
                document.getElementById('weekly-dist').innerText = weeklyDist.toFixed(1) + "k";
            } catch (e) { console.error(e); }
        };

        // 3. ê°œë³„ ê¸°ë¡ ìˆ˜ì • íŒì—… ì œì–´
        window.openSpecificEditModal = (logId, memberId, date, distance, pace, location) => {
            // í†µê³„ íŒì—…ì€ ê·¸ëŒ€ë¡œ ë‘ê³  ê·¸ ìœ„ì— ìˆ˜ì • íŒì—…ì„ ë„ì›€
            document.getElementById('spec-log-id').value = logId;
            document.getElementById('spec-member-id').value = memberId;
            document.getElementById('spec-date').value = date;
            document.getElementById('spec-distance').value = distance;
            document.getElementById('spec-pace').value = pace;
            document.getElementById('spec-location').value = location;

            const overlay = document.getElementById('edit-specific-log-modal');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);
        };

        window.closeSpecificEditModal = () => {
            const overlay = document.getElementById('edit-specific-log-modal');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        };

        window.saveSpecificLogEdit = async () => {
            const logId = document.getElementById('spec-log-id').value;
            const memberId = document.getElementById('spec-member-id').value;
            const date = document.getElementById('spec-date').value;
            const distance = parseFloat(document.getElementById('spec-distance').value);
            const pace = document.getElementById('spec-pace').value;
            const location = document.getElementById('spec-location').value;

            if(!date || isNaN(distance) || !pace) return alert('ëª¨ë“  ì •ë³´ë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.');

            try {
                // 1. ê°œë³„ ë¡œê·¸ ì—…ë°ì´íŠ¸
                await updateDoc(doc(db, "activity_logs", logId), { date, distance, pace, location });
                
                // 2. ëˆ„ê³„ ë°ì´í„° ì¬ê³„ì‚° ë° ì—…ë°ì´íŠ¸
                await recalculateMemberStats(memberId);
                
                alert('ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.closeSpecificEditModal();
                // í†µê³„ íŒì—…ì˜ ë°ì´í„°ë„ ìµœì‹ í™”í•˜ê¸° ìœ„í•´ ë‹¤ì‹œ ë¡œë“œ
                window.showStats(memberId, document.getElementById('stats-member-name').innerText);
            } catch (e) { alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ'); }
        };

        window.deleteSpecificLog = async (logId, memberId) => {
            if (!confirm('ì´ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await deleteDoc(doc(db, "activity_logs", logId));
                await recalculateMemberStats(memberId);
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.showStats(memberId, document.getElementById('stats-member-name').innerText);
            } catch (e) { alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'); }
        };

        async function recalculateMemberStats(memberId) {
            const q = query(logsCol, where("memberId", "==", memberId));
            const snap = await getDocs(q);
            let d = 0; let c = 0;
            snap.forEach(l => { d += (l.data().distance || 0); c += 1; });
            await updateDoc(doc(db, "members", memberId), { distance: Number(d.toFixed(1)), count: c });
        }

        window.closeStatsModal = () => {
            const overlay = document.getElementById('stats-modal-overlay');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        };

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° (ì´ì¤‘ íŒì—… ëŒ€ì‘)
        window.handleOverlayClick = (e) => {
            if(e.target.id === 'edit-specific-log-modal') window.closeSpecificEditModal();
            else if(e.target.id === 'stats-modal-overlay') window.closeStatsModal();
        };
    </script>
</body>
</html>
