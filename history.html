<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì†”ë¼ëŸ¬ë‹í¬ë£¨ - íšŒì› ê¸°ë¡</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <aside>
        <div class="sidebar-header">
            <a href="index.html">ì†”ë¼ëŸ¬ë‹í¬ë£¨</a>
        </div>
        <nav>
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span><span>í™ˆ</span>
            </a>
            <a href="history.html" class="nav-item active">
                <span class="nav-icon">ğŸ“Š</span><span>íšŒì› ê¸°ë¡</span>
            </a>
            <a href="records.html" class="nav-item">
                <span class="nav-icon">ğŸ“‹</span><span>ê¸°ë¡ ë“±ë¡</span>
            </a>
            <a href="members.html" class="nav-item" id="nav-members" style="display: none;">
                <span class="nav-icon">ğŸ‘¤</span><span>íšŒì› ê´€ë¦¬</span>
            </a>
        </nav>
    </aside>

    <main>
        <header>
            <h1>íšŒì› ê¸°ë¡ í†µê³„</h1>
            <div style="color: var(--text-muted); font-size: 0.85rem;" id="sync-status">ì‹¤ì‹œê°„ ì—°ë™ ì¤‘</div>
        </header>

        <div class="card">
            <h3 style="margin-bottom: 1.25rem;">ëˆ„ì  í™œë™ ë°ì´í„°</h3>
            <div style="overflow-x: auto; margin: 0 -0.75rem;">
                <table class="data-table" style="min-width: 550px; width: 100%;">
                    <thead>
                        <tr>
                            <th style="padding-left: 0.75rem; width: 80px;">ì´ë¦„</th>
                            <th style="width: 90px;">ì´ê±°ë¦¬</th>
                            <th style="width: 80px;">í˜ì´ìŠ¤</th>
                            <th style="width: 90px;">ì´ì‹œê°„</th>
                            <th style="width: 60px;">íšŸìˆ˜</th>
                            <th style="padding-right: 0.75rem; text-align: right;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="history-list">
                        <tr><td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-muted);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Popup Modal: Member Statistics -->
    <div class="modal-overlay" id="stats-modal-overlay" onclick="window.handleOverlayClick(event)">
        <div class="modal">
            <div class="modal-header">
                <h3>íšŒì› í™œë™ ê¸°ë¡</h3>
                <button onclick="window.closeStatsModal()" style="border:none; background:none; font-size: 1.75rem; cursor:pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="stats-member-info" style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 1.25rem; font-weight: 800; color: var(--text-main);" id="stats-member-name">--</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">í™œë™ ì´ë ¥ ë° í†µê³„</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="label">ì´ë²ˆ ë‹¬ ê±°ë¦¬</span>
                        <span class="value" id="monthly-dist">0.0k</span>
                    </div>
                    <div class="stat-box">
                        <span class="label">ìµœê·¼ 7ì¼ ê±°ë¦¬</span>
                        <span class="value" id="weekly-dist">0.0k</span>
                    </div>
                </div>
                <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.5rem;">ìµœê·¼ í™œë™ (ì£¼ì°¨ë³„ êµ¬ë¶„)</div>
                <div class="history-list" id="history-items"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="window.closeStatsModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Popup Modal: Edit Specific Log Record -->
    <div class="modal-overlay" id="edit-specific-log-modal" onclick="window.handleOverlayClick(event)">
        <div class="modal">
            <div class="modal-header">
                <h3>í™œë™ ê¸°ë¡ ìˆ˜ì •</h3>
                <button onclick="window.closeSpecificEditModal()" style="border:none; background:none; font-size: 1.75rem; cursor:pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="specific-log-form">
                    <input type="hidden" id="spec-log-id">
                    <input type="hidden" id="spec-member-id">
                    <div class="form-group">
                        <label>ìš´ë™ ë‚ ì§œ</label>
                        <input type="date" id="spec-date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>ëŸ¬ë‹ ì¥ì†Œ</label>
                        <select id="spec-location" class="form-control">
                            <option value="ì‹¤ì™¸">ì‹¤ì™¸ (Outdoor)</option>
                            <option value="ì‹¤ë‚´">ì‹¤ë‚´ (Indoor)</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>ê±°ë¦¬ (km)</label>
                            <input type="number" id="spec-distance" class="form-control" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>í˜ì´ìŠ¤</label>
                            <input type="text" id="spec-pace" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="window.closeSpecificEditModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="window.saveSpecificLogEdit()">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- Popup Modal: Last Log Edit (For quick management) -->
    <div class="modal-overlay" id="edit-log-modal" onclick="window.handleOverlayClick(event)">
        <div class="modal">
            <div class="modal-header">
                <h3>ë§ˆì§€ë§‰ ê¸°ë¡ ìˆ˜ì •</h3>
                <button onclick="window.closeEditModal()" style="border:none; background:none; font-size: 1.75rem; cursor:pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="edit-target-info" style="margin-bottom: 1.25rem; padding: 1rem; background: #f8fafc; border-radius: 0.75rem; border: 1px solid #e2e8f0;">
                    <div style="font-size: 0.8rem; color: #64748b;">ìˆ˜ì • ëŒ€ìƒ íšŒì›</div>
                    <div style="font-size: 1.1rem; font-weight: 800; color: var(--primary-color);" id="edit-member-name-label">--</div>
                </div>
                <form id="log-edit-form">
                    <input type="hidden" id="edit-log-id">
                    <input type="hidden" id="edit-member-id">
                    <div class="form-group">
                        <label>ìš´ë™ ë‚ ì§œ</label>
                        <input type="date" id="edit-log-date" class="form-control">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>ê±°ë¦¬ (km)</label>
                            <input type="number" id="edit-log-distance" class="form-control" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>í˜ì´ìŠ¤</label>
                            <input type="text" id="edit-log-pace" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="window.closeEditModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="window.saveLogEdit()">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- [ë³´ì•ˆ] ë¡œê·¸ì¸ ë° ë©”ë‰´ ì œì–´ ---
        const checkAuth = () => {
            const user = JSON.parse(localStorage.getItem('crew_user'));
            if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); window.location.href = 'index.html'; return null; }
            if (user.role === 'admin') {
                const navMembers = document.getElementById('nav-members');
                if (navMembers) navMembers.style.display = 'flex';
            }
            return user;
        };
        const currentUser = checkAuth();
        if (!currentUser) throw new Error("Unauthorized");

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, where, getDocs, limit } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1TE3jtcdcH6UvbfPGIy_IeaVivg2YvPA",
            authDomain: "run-app-268d5.firebaseapp.com",
            projectId: "run-app-268d5",
            storageBucket: "run-app-268d5.firebasestorage.app",
            messagingSenderId: "1064940196481",
            appId: "1:1064940196481:web:0408fd1fb557c4b2a2b380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const membersCol = collection(db, "members");
        const logsCol = collection(db, "activity_logs");

        // 1. ì‹¤ì‹œê°„ ëˆ„ê³„ ë°ì´í„° ë¡œë“œ
        onSnapshot(query(membersCol, orderBy("name")), (snapshot) => {
            const tbody = document.getElementById('history-list');
            const thead = document.querySelector('thead tr');
            tbody.innerHTML = '';
            
            if (currentUser.role !== 'admin') {
                const manageHeader = thead.querySelector('th:last-child');
                if (manageHeader) manageHeader.style.display = 'none';
            }

            snapshot.forEach((docSnap) => {
                const m = docSnap.data();
                const tr = document.createElement('tr');
                const totalMinutes = m.totalTime || 0;
                const h = Math.floor(totalMinutes / 60);
                const min = Math.round(totalMinutes % 60);
                const timeStr = h > 0 ? `${h}ì‹œê°„ ${min}ë¶„` : `${min}ë¶„`;

                let rowHtml = `
                    <td style="padding-left: 0.75rem; font-weight: 700; color: var(--primary-color); cursor: pointer;" onclick="window.showStats('${docSnap.id}', '${m.name}')">${m.name}</td>
                    <td><span style="color: var(--text-main); font-weight: 800;">${m.distance || 0}</span> km</td>
                    <td><span style="font-family: monospace; font-size: 0.85rem;">${m.pace || "0'00\""}</span></td>
                    <td style="font-size: 0.85rem;">${timeStr}</td>
                    <td>${m.count || 0} íšŒ</td>
                `;

                if (currentUser.role === 'admin') {
                    rowHtml += `
                        <td style="padding-right: 0.75rem; text-align: right;">
                            <button class="btn btn-outline btn-sm" style="padding: 0.4rem 0.6rem;" onclick="window.openLastLogEdit('${docSnap.id}', '${m.name}')">ìˆ˜ì •</button>
                        </td>
                    `;
                }
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
            document.getElementById('sync-status').innerText = "ì‹¤ì‹œê°„ ì—°ë™ ì™„ë£Œ";
        });

        // 2. íšŒì› ìƒì„¸ í†µê³„ ë³´ê¸°
        window.showStats = async (memberId, memberName) => {
            document.getElementById('stats-member-name').innerText = memberName;
            const historyContainer = document.getElementById('history-items');
            historyContainer.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-muted);">ë¶„ì„ ì¤‘...</div>';
            
            const overlay = document.getElementById('stats-modal-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);

            try {
                const q = query(logsCol, where("memberId", "==", memberId));
                const querySnapshot = await getDocs(q);
                let monthlyDist = 0; let weeklyDist = 0;
                const now = new Date();
                const oneMonthAgo = new Date(); oneMonthAgo.setMonth(now.getMonth() - 1);
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7);
                
                const logs = [];
                querySnapshot.forEach((d) => logs.push({ id: d.id, ...d.data() }));
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                historyContainer.innerHTML = '';
                logs.forEach((log) => {
                    const logDate = new Date(log.date);
                    if (logDate >= oneMonthAgo) monthlyDist += log.distance;
                    if (logDate >= oneWeekAgo) weeklyDist += log.distance;
                    const weekNum = getWeekNumber(logDate);
                    const weekClass = weekNum % 2 === 0 ? 'week-even' : 'week-odd';
                    
                    const item = document.createElement('div');
                    item.className = `history-item ${weekClass}`;
                    item.style.flexDirection = 'column';
                    item.style.alignItems = 'flex-start';

                    let actionsHtml = '';
                    if (currentUser.role === 'admin') {
                        actionsHtml = `
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end; width: 100%;">
                                <button class="btn btn-outline btn-sm" style="flex: 1; min-height: 44px;" onclick="window.openSpecificEditModal('${log.id}', '${memberId}', '${log.date}', ${log.distance}, '${log.pace}', '${log.location || 'ì‹¤ì™¸'}')">ìˆ˜ì •</button>
                                <button class="btn btn-danger btn-sm" style="flex: 1; min-height: 44px;" onclick="window.deleteSpecificLog('${log.id}', '${memberId}')">ì‚­ì œ</button>
                            </div>
                        `;
                    }

                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                            <div class="date" style="font-size: 0.95rem;">${log.date} <small>[${log.location || 'ì‹¤ì™¸'}]</small></div>
                            <div class="metrics" style="text-align: right;">
                                <span class="dist" style="display:block; font-weight: 800;">${log.distance}km</span>
                                <div class="pace" style="font-size: 0.8rem;">${log.pace}</div>
                            </div>
                        </div>
                        ${actionsHtml}
                    `;
                    historyContainer.appendChild(item);
                });
                document.getElementById('monthly-dist').innerText = monthlyDist.toFixed(1) + "k";
                document.getElementById('weekly-dist').innerText = weeklyDist.toFixed(1) + "k";
            } catch (e) { console.error(e); }
        };

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // --- ìˆ˜ì •/ì‚­ì œ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
        window.openLastLogEdit = async (memberId, memberName) => {
            document.getElementById('edit-member-name-label').innerText = memberName;
            document.getElementById('edit-member-id').value = memberId;
            try {
                const q = query(logsCol, where("memberId", "==", memberId));
                const snap = await getDocs(q);
                if (snap.empty) { alert('ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                const logs = []; snap.forEach(d => logs.push({id: d.id, ...d.data()}));
                logs.sort((a,b) => new Date(b.date) - new Date(a.date));
                const last = logs[0];
                document.getElementById('edit-log-id').value = last.id;
                document.getElementById('edit-log-date').value = last.date;
                document.getElementById('edit-log-distance').value = last.distance;
                document.getElementById('edit-log-pace').value = last.pace;
                const overlay = document.getElementById('edit-log-modal');
                overlay.style.display = 'flex';
                setTimeout(() => overlay.classList.add('active'), 10);
            } catch (e) { alert('ì—ëŸ¬ ë°œìƒ'); }
        };

        window.openSpecificEditModal = (logId, memberId, date, distance, pace, location) => {
            document.getElementById('spec-log-id').value = logId;
            document.getElementById('spec-member-id').value = memberId;
            document.getElementById('spec-date').value = date;
            document.getElementById('spec-distance').value = distance;
            document.getElementById('spec-pace').value = pace;
            document.getElementById('spec-location').value = location;
            const overlay = document.getElementById('edit-specific-log-modal');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);
        };

        window.closeSpecificEditModal = () => {
            const overlay = document.getElementById('edit-specific-log-modal');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        };

        window.saveSpecificLogEdit = async () => {
            const logId = document.getElementById('spec-log-id').value;
            const memberId = document.getElementById('spec-member-id').value;
            const date = document.getElementById('spec-date').value;
            const distance = parseFloat(document.getElementById('spec-distance').value);
            const pace = document.getElementById('spec-pace').value;
            const location = document.getElementById('spec-location').value;
            try {
                await updateDoc(doc(db, "activity_logs", logId), { date, distance, pace, location });
                await recalculateMemberStats(memberId);
                alert('ìˆ˜ì • ì™„ë£Œ');
                window.closeSpecificEditModal();
                window.closeStatsModal();
            } catch (e) { alert('ìˆ˜ì • ì‹¤íŒ¨'); }
        };

        window.deleteSpecificLog = async (logId, memberId) => {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await deleteDoc(doc(db, "activity_logs", logId));
                await recalculateMemberStats(memberId);
                alert('ì‚­ì œ ì™„ë£Œ');
                window.closeStatsModal();
            } catch (e) { alert('ì‚­ì œ ì‹¤íŒ¨'); }
        };

        async function recalculateMemberStats(memberId) {
            const q = query(logsCol, where("memberId", "==", memberId));
            const snap = await getDocs(q);
            let d = 0; let c = 0;
            snap.forEach(l => { d += l.data().distance; c += 1; });
            await updateDoc(doc(db, "members", memberId), { distance: Number(d.toFixed(1)), count: c });
        }

        window.closeEditModal = () => {
            const overlay = document.getElementById('edit-log-modal');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        };

        window.closeStatsModal = () => {
            const overlay = document.getElementById('stats-modal-overlay');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        };

        window.handleOverlayClick = (e) => {
            if(e.target.classList.contains('modal-overlay')) {
                window.closeEditModal();
                window.closeStatsModal();
                window.closeSpecificEditModal();
            }
        };
    </script>
</body>
</html>
