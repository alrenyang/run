<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì†”ë¼ëŸ¬ë‹í¬ë£¨ - íšŒì› ê´€ë¦¬</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <aside>
        <div class="sidebar-header">
            <a href="index.html">ì†”ë¼ëŸ¬ë‹í¬ë£¨</a>
        </div>
        <nav>
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span>í™ˆ</span>
            </a>
            <a href="members.html" class="nav-item active">
                <span class="nav-icon">ğŸ‘¤</span>
                <span>íšŒì› ê´€ë¦¬</span>
            </a>
            <a href="records.html" class="nav-item">
                <span class="nav-icon">ğŸ“‹</span>
                <span>ê¸°ë¡ ë“±ë¡</span>
            </a>
        </nav>
    </aside>

    <main>
        <header style="flex-direction: column; align-items: stretch; gap: 1rem;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <h1>íšŒì› ê´€ë¦¬</h1>
                <div style="color: var(--text-muted); font-size: 0.85rem;" id="date-display">--</div>
            </div>
            <button class="btn btn-primary btn-lg" onclick="window.openModal()" style="margin-top: 0.5rem;">
                <span style="font-size: 1.4rem;">+</span> ì‹ ê·œ íšŒì› ë“±ë¡í•˜ê¸°
            </button>
        </header>

        <div class="card">
            <h3 style="margin-bottom: 1.25rem;">íšŒì›ë³„ ëª©í‘œ ë° ì •ë³´</h3>
            <div style="overflow-x: auto; margin: 0 -0.75rem;">
                <table class="data-table" style="min-width: 480px; width: 100%;">
                    <thead>
                        <tr>
                            <th style="padding-left: 0.75rem; width: 40px;">#</th>
                            <th style="width: 80px;">ì´ë¦„</th>
                            <th style="width: 80px;">ìµœì†Œê±°ë¦¬</th>
                            <th style="width: 70px;">ìµœì†Œì‹œê°„</th>
                            <th style="width: 60px;">ì£¼ê°„íšŸìˆ˜</th>
                            <th style="padding-right: 0.75rem; text-align: right;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="member-list">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Popup Modal: Member Add/Edit -->
    <div class="modal-overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">ì‹ ê·œ íšŒì› ë“±ë¡</h3>
                <button onclick="closeModal()" style="border:none; background:none; font-size: 1.75rem; cursor:pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="member-form" onsubmit="event.preventDefault();">
                    <input type="hidden" id="member-doc-id">
                    <div class="form-group">
                        <label for="name">íšŒì› ì´ë¦„</label>
                        <input type="text" id="name" class="form-control" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="minDistance">ìµœì†Œê±°ë¦¬ (km)</label>
                            <input type="number" id="minDistance" class="form-control" placeholder="0.0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="minTime">ìµœì†Œì‹œê°„ (ë¶„)</label>
                            <input type="number" id="minTime" class="form-control" placeholder="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="weeklyCount">ì£¼ê°„ëŸ¬ë‹íšŸìˆ˜ (íšŒ)</label>
                        <input type="number" id="weeklyCount" class="form-control" placeholder="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="save-btn" onclick="saveMember()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Popup Modal: Member Statistics (Keep existing functionality) -->
    <div class="modal-overlay" id="stats-modal-overlay" onclick="handleOverlayClick(event)">
        <div class="modal">
            <div class="modal-header">
                <h3>íšŒì› í™œë™ ê¸°ë¡</h3>
                <button onclick="closeStatsModal()" style="border:none; background:none; font-size: 1.75rem; cursor:pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="stats-member-info" style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 1.25rem; font-weight: 800; color: var(--text-main);" id="stats-member-name">--</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">í™œë™ ì´ë ¥ ë° í†µê³„</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="label">ì´ë²ˆ ë‹¬ ê±°ë¦¬</span>
                        <span class="value" id="monthly-dist">0.0k</span>
                    </div>
                    <div class="stat-box">
                        <span class="label">ìµœê·¼ 7ì¼ ê±°ë¦¬</span>
                        <span class="value" id="weekly-dist">0.0k</span>
                    </div>
                </div>
                <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.5rem;">ìµœê·¼ í™œë™ (ì£¼ì°¨ë³„ êµ¬ë¶„)</div>
                <div class="history-list" id="history-items"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeStatsModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, where, getDocs } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ğŸ”¥ ë³¸ì¸ì˜ Firebase ì„¤ì •ê°’ìœ¼ë¡œ êµì²´í•´ ì£¼ì„¸ìš”!
        const firebaseConfig = {
            apiKey: "AIzaSyD1TE3jtcdcH6UvbfPGIy_IeaVivg2YvPA",
            authDomain: "run-app-268d5.firebaseapp.com",
            projectId: "run-app-268d5",
            storageBucket: "run-app-268d5.firebasestorage.app",
            messagingSenderId: "1064940196481",
            appId: "1:1064940196481:web:0408fd1fb557c4b2a2b380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const membersCol = collection(db, "members");

        // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
        const today = new Date();
        document.getElementById('date-display').innerText = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

        // íšŒì› ëª©ë¡ ì‹¤ì‹œê°„ ë Œë”ë§
        onSnapshot(query(membersCol, orderBy("name")), (snapshot) => {
            const tbody = document.getElementById('member-list');
            tbody.innerHTML = '';
            
            if(snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            let index = 1;
            snapshot.forEach((doc) => {
                const member = doc.data();
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td style="padding-left: 0.75rem; color: var(--text-muted); font-size: 0.75rem;">${index++}</td>
                    <td style="font-weight: 600; color: var(--primary-color); cursor: pointer;" onclick="window.showStats('${doc.id}', '${member.name}')">${member.name}</td>
                    <td><span style="font-weight: 700;">${member.minDistance || 0}</span> km</td>
                    <td>${member.minTime || 0} ë¶„</td>
                    <td><span style="background: #f3f4f6; padding: 0.15rem 0.35rem; border-radius: 0.4rem; font-family: monospace; font-size: 0.8rem;">${member.weeklyCount || 0} íšŒ</span></td>
                    <td style="padding-right: 0.75rem; text-align: right;">
                        <div style="display: flex; gap: 0.3rem; justify-content: flex-end;">
                            <button class="btn btn-outline btn-sm" style="padding: 0.3rem 0.5rem;" onclick="window.editMember('${doc.id}', '${member.name}', ${member.minDistance || 0}, ${member.minTime || 0}, ${member.weeklyCount || 0})">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-sm" style="padding: 0.3rem 0.5rem;" onclick="window.deleteMember('${doc.id}')">ì‚­ì œ</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        });

        // íšŒì›ë³„ í†µê³„ ë³´ê¸°
        window.showStats = async (memberId, memberName) => {
            document.getElementById('stats-member-name').innerText = memberName;
            const historyContainer = document.getElementById('history-items');
            historyContainer.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted);">ë°ì´í„° ë¶„ì„ ì¤‘...</div>';
            
            const overlay = document.getElementById('stats-modal-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);

            try {
                const q = query(collection(db, "activity_logs"), where("memberId", "==", memberId));
                const querySnapshot = await getDocs(q);
                
                let monthlyDist = 0;
                let weeklyDist = 0;
                const now = new Date();
                const oneMonthAgo = new Date(); oneMonthAgo.setMonth(now.getMonth() - 1);
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7);
                
                historyContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    historyContainer.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-muted);">ë“±ë¡ëœ í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    document.getElementById('monthly-dist').innerText = "0.0k";
                    document.getElementById('weekly-dist').innerText = "0.0k";
                    return;
                }

                const logs = [];
                querySnapshot.forEach((docSnap) => logs.push(docSnap.data()));
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                logs.forEach((log) => {
                    const logDate = new Date(log.date);
                    if (logDate >= oneMonthAgo) monthlyDist += log.distance;
                    if (logDate >= oneWeekAgo) weeklyDist += log.distance;
                    const weekNum = getWeekNumber(logDate);
                    const weekClass = weekNum % 2 === 0 ? 'week-even' : 'week-odd';
                    const item = document.createElement('div');
                    item.className = `history-item ${weekClass}`;
                    item.innerHTML = `
                        <div class="date">${log.date}</div>
                        <div class="metrics">
                            <span class="dist">${log.distance}km</span>
                            <div class="pace">${log.pace}</div>
                        </div>
                    `;
                    historyContainer.appendChild(item);
                });
                document.getElementById('monthly-dist').innerText = monthlyDist.toFixed(1) + "k";
                document.getElementById('weekly-dist').innerText = weeklyDist.toFixed(1) + "k";
            } catch (e) {
                historyContainer.innerHTML = '<div style="text-align:center; padding:1rem; color:red;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        };

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        window.closeStatsModal = () => {
            const overlay = document.getElementById('stats-modal-overlay');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        };

        window.openModal = () => {
            document.getElementById('modal-title').innerText = 'ì‹ ê·œ íšŒì› ë“±ë¡';
            const form = document.getElementById('member-form');
            if (form) form.reset();
            document.getElementById('member-doc-id').value = '';
            const overlay = document.getElementById('modal-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);
        };

        window.closeModal = () => {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        };

        window.saveMember = async () => {
            const id = document.getElementById('member-doc-id').value;
            const name = document.getElementById('name').value;
            const minDistance = parseFloat(document.getElementById('minDistance').value) || 0;
            const minTime = parseInt(document.getElementById('minTime').value) || 0;
            const weeklyCount = parseInt(document.getElementById('weeklyCount').value) || 0;

            if(!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');

            try {
                const data = { name, minDistance, minTime, weeklyCount };
                if(id) {
                    await updateDoc(doc(db, "members", id), data);
                } else {
                    await addDoc(membersCol, data);
                }
                window.closeModal();
            } catch (e) {
                alert("ì €ì¥ ì˜¤ë¥˜: " + e.message);
            }
        };

        window.deleteMember = async (id) => {
            if(confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await deleteDoc(doc(db, "members", id));
            }
        };

        window.editMember = (id, name, minDistance, minTime, weeklyCount) => {
            document.getElementById('modal-title').innerText = 'íšŒì› ì •ë³´ ìˆ˜ì •';
            document.getElementById('member-doc-id').value = id;
            document.getElementById('name').value = name;
            document.getElementById('minDistance').value = minDistance;
            document.getElementById('minTime').value = minTime;
            document.getElementById('weeklyCount').value = weeklyCount;
            const overlay = document.getElementById('modal-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);
        };

        window.handleOverlayClick = (e) => {
            if(e.target.classList.contains('modal-overlay')) {
                window.closeModal();
                window.closeStatsModal();
            }
        };
    </script>
</body>
</html>
