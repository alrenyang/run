<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†”ë¼ëŸ¬ë‹í¬ë£¨ - ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .compact-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
        .stat-card-wide { grid-column: span 2; background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; padding: 1.5rem; border-radius: 1.25rem; text-align: center; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }
        .stat-card-small { background: white; padding: 1.25rem 1rem; border-radius: 1.25rem; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .stat-card-wide .label { font-size: 0.9rem; font-weight: 600; opacity: 0.9; margin-bottom: 0.5rem; display: block; }
        .stat-card-wide .value { font-size: 2.5rem; font-weight: 900; }
        .stat-card-small .label { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin-bottom: 0.25rem; display: block; }
        .stat-card-small .value { font-size: 1.5rem; font-weight: 800; color: var(--text-main); }
        @media (max-width: 480px) { .stat-card-wide .value { font-size: 2.2rem; } .stat-card-small .value { font-size: 1.25rem; } }
    </style>
</head>
<body>
    <!-- 1. Auth Section (Login/Signup) -->
    <div id="auth-section" class="active">
        <div class="auth-container">
            <div class="auth-header">
                <h2>ì†”ë¼ëŸ¬ë‹í¬ë£¨</h2>
                <p style="color: var(--text-muted); margin-top: 0.5rem;" id="auth-desc">ë°˜ê°‘ìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.</p>
            </div>
            
            <form id="auth-form" onsubmit="event.preventDefault();">
                <div class="form-group" style="text-align: left;">
                    <label>ì´ë¦„</label>
                    <input type="text" id="auth-name" class="form-control" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label>ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì)</label>
                    <input type="password" id="auth-pw" class="form-control" placeholder="ìˆ«ìë§Œ ì…ë ¥" inputmode="numeric" pattern="[0-9]*">
                </div>
                <button class="btn btn-primary btn-lg" style="width: 100%; margin-top: 1rem;" onclick="window.handleAuth()" id="auth-btn">ë¡œê·¸ì¸</button>
            </form>

            <div class="auth-toggle" id="auth-toggle-wrapper">
                ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span onclick="window.toggleAuthMode()">íšŒì›ê°€ì… í•˜ê¸°</span>
            </div>
        </div>
    </div>

    <!-- 2. App Section (Dashboard) -->
    <div id="app-section">
        <aside>
            <div class="sidebar-header">
                <a href="index.html">ì†”ë¼ëŸ¬ë‹í¬ë£¨</a>
            </div>
            <nav>
                <a href="index.html" class="nav-item active">
                    <span class="nav-icon">ğŸ </span>
                    <span>í™ˆ</span>
                </a>
                <a href="history.html" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>íšŒì› ê¸°ë¡</span>
                </a>
                <a href="records.html" class="nav-item">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>ê¸°ë¡ ë“±ë¡</span>
                </a>
                <a href="members.html" class="nav-item">
                    <span class="nav-icon">ğŸ‘¤</span>
                    <span>íšŒì› ê´€ë¦¬</span>
                </a>
            </nav>
        </aside>

        <main>
            <div class="user-info-bar">
                <div style="font-weight: 700;"><span id="user-display-name">--</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</div>
                <div class="logout-btn" onclick="window.handleLogout()">ë¡œê·¸ì•„ì›ƒ</div>
            </div>

            <header>
                <h1>ì†”ë¼ëŸ¬ë‹í¬ë£¨</h1>
                <div id="current-date-text" style="color: var(--text-muted); font-size: 0.875rem;">--</div>
            </header>

            <div class="stat-card-wide">
                <span class="label">ğŸƒ í¬ë£¨ ì´ ëŸ¬ë‹ê±°ë¦¬</span>
                <div class="value"><span id="crew-total-distance">0.0</span> <span style="font-size: 1.2rem; font-weight: 600;">km</span></div>
            </div>

            <div style="margin-top: 1rem;" class="compact-stats-grid">
                <div class="stat-card-small">
                    <span class="label">ğŸ‘¥ ì´ íšŒì›ìˆ˜</span>
                    <div class="value" id="total-members-count">-- ëª…</div>
                </div>
                <div class="stat-card-small">
                    <span class="label">ğŸ“… ì˜¤ëŠ˜ ê¸°ë¡</span>
                    <div class="value" id="today-records-count">-- ê±´</div>
                </div>
            </div>

            <div class="card" style="margin-top: 1rem; border-style: dashed; background: transparent;">
                <p style="text-align: center; color: var(--text-muted); font-size: 0.85rem; line-height: 1.5;">
                    ê¸°ë¡ ë“±ë¡ ë©”ë‰´ì—ì„œ ì˜¤ëŠ˜ ëŸ°ë‹ì„ ì¸ì¦í•´ ì£¼ì„¸ìš”!
                </p>
            </div>

            <!-- Version Info -->
            <div style="text-align: center; margin-top: 2rem; padding-bottom: 1rem; opacity: 0.4;">
                <small style="font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.5px;">SYSTEM UPDATE v1.0.2</small>
            </div>
        </main>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, getDocs, addDoc } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ğŸ”¥ Firebase ì„¤ì •ê°’
        const firebaseConfig = {
            apiKey: "AIzaSyD1TE3jtcdcH6UvbfPGIy_IeaVivg2YvPA",
            authDomain: "run-app-268d5.firebaseapp.com",
            projectId: "run-app-268d5",
            storageBucket: "run-app-268d5.firebasestorage.app",
            messagingSenderId: "1064940196481",
            appId: "1:1064940196481:web:0408fd1fb557c4b2a2b380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const usersCol = collection(db, "app_users");

        let isLoginMode = true;

        // --- ì¸ì¦ ë¡œì§ ---
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-btn').innerText = isLoginMode ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…';
            document.getElementById('auth-desc').innerText = isLoginMode ? 'ë°˜ê°‘ìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.' : 'ìƒˆë¡œìš´ í¬ë£¨ ê³„ì •ì„ ë§Œë“­ë‹ˆë‹¤.';
            document.getElementById('auth-toggle-wrapper').innerHTML = isLoginMode ? 
                'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span onclick="window.toggleAuthMode()">íšŒì›ê°€ì… í•˜ê¸°</span>' :
                'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <span onclick="window.toggleAuthMode()">ë¡œê·¸ì¸ í•˜ê¸°</span>';
        };

        window.handleAuth = async () => {
            const name = document.getElementById('auth-name').value.trim();
            const pw = document.getElementById('auth-pw').value.trim();

            if(!name || !pw) return alert('ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');

            if (isLoginMode) {
                // ë¡œê·¸ì¸
                const q = query(usersCol, where("name", "==", name), where("password", "==", pw));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    alert('ì´ë¦„ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                } else {
                    const userData = { name };
                    localStorage.setItem('crew_user', JSON.stringify(userData));
                    checkAuth();
                }
            } else {
                // íšŒì›ê°€ì…
                const q = query(usersCol, where("name", "==", name));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.');
                }
                await addDoc(usersCol, { name, password: pw });
                alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
                window.toggleAuthMode();
            }
        };

        window.handleLogout = () => {
            localStorage.removeItem('crew_user');
            location.reload();
        };

        const checkAuth = () => {
            const user = localStorage.getItem('crew_user');
            if (user) {
                const userData = JSON.parse(user);
                document.getElementById('user-display-name').innerText = userData.name;
                document.getElementById('auth-section').classList.remove('active');
                document.getElementById('app-section').classList.add('active');
                initDashboard();
            } else {
                document.getElementById('auth-section').classList.add('active');
                document.getElementById('app-section').classList.remove('active');
            }
        };

        // --- ëŒ€ì‹œë³´ë“œ ë¡œì§ ---
        const initDashboard = () => {
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            document.getElementById('current-date-text').innerText = `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼`;

            onSnapshot(collection(db, "members"), (snapshot) => {
                document.getElementById('total-members-count').innerText = `${snapshot.size} ëª…`;
                let totalKm = 0;
                snapshot.forEach((doc) => { totalKm += (doc.data().distance || 0); });
                document.getElementById('crew-total-distance').innerText = totalKm.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1});
            });

            const activityQuery = query(collection(db, "activity_logs"), where("date", "==", todayStr));
            onSnapshot(activityQuery, (snapshot) => {
                document.getElementById('today-records-count').innerText = `${snapshot.size} ê±´`;
            });
        };

        checkAuth();
    </script>
</body>
</html>
