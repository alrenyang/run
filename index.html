<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†”ë¼ëŸ¬ë‹í¬ë£¨ - ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .compact-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
        .stat-card-wide { grid-column: span 2; background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; padding: 1.5rem; border-radius: 1.25rem; text-align: center; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }
        .stat-card-small { background: white; padding: 1.25rem 1rem; border-radius: 1.25rem; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .stat-card-wide .label { font-size: 0.9rem; font-weight: 600; opacity: 0.9; margin-bottom: 0.5rem; display: block; }
        .stat-card-wide .value { font-size: 2.5rem; font-weight: 900; }
        .stat-card-small .label { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin-bottom: 0.25rem; display: block; }
        .stat-card-small .value { font-size: 1.5rem; font-weight: 800; color: var(--text-main); }
        @media (max-width: 480px) { .stat-card-wide .value { font-size: 2.2rem; } .stat-card-small .value { font-size: 1.25rem; } }
        
        /* Admin Badge */
        .admin-badge {
            background: #fef3c7;
            color: #92400e;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: 800;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <!-- 1. Auth Section -->
    <div id="auth-section" class="active">
        <div class="auth-container">
            <div class="auth-header">
                <h2>ì†”ë¼ëŸ¬ë‹í¬ë£¨</h2>
                <p style="color: var(--text-muted); margin-top: 0.5rem;" id="auth-desc">ë°˜ê°‘ìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.</p>
            </div>
            <form id="auth-form" onsubmit="event.preventDefault();">
                <div class="form-group" style="text-align: left;">
                    <label>ì´ë¦„</label>
                    <input type="text" id="auth-name" class="form-control" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label>ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì)</label>
                    <input type="password" id="auth-pw" class="form-control" placeholder="ìˆ«ìë§Œ ì…ë ¥" inputmode="numeric">
                </div>
                <button class="btn btn-primary btn-lg" style="width: 100%; margin-top: 1rem;" onclick="window.handleAuth()" id="auth-btn">ë¡œê·¸ì¸</button>
            </form>
            <div class="auth-toggle" id="auth-toggle-wrapper">
                ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span onclick="window.toggleAuthMode()">íšŒì›ê°€ì… í•˜ê¸°</span>
            </div>
        </div>
    </div>

    <!-- 2. App Section -->
    <div id="app-section">
        <aside>
            <div class="sidebar-header">
                <a href="index.html">ì†”ë¼ëŸ¬ë‹í¬ë£¨</a>
            </div>
            <nav id="main-nav">
                <a href="index.html" class="nav-item active"><span class="nav-icon">ğŸ </span><span>í™ˆ</span></a>
                <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span><span>íšŒì› ê¸°ë¡</span></a>
                <a href="records.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span><span>ê¸°ë¡ ë“±ë¡</span></a>
                <!-- íšŒì› ê´€ë¦¬ëŠ” ê´€ë¦¬ìì—ê²Œë§Œ ë…¸ì¶œ -->
                <a href="members.html" class="nav-item" id="nav-members" style="display: none;"><span class="nav-icon">ğŸ‘¤</span><span>íšŒì› ê´€ë¦¬</span></a>
            </nav>
        </aside>

        <main>
            <div class="user-info-bar">
                <div style="font-weight: 700;">
                    <span id="user-display-name">--</span>ë‹˜ 
                    <span id="user-role-badge"></span>
                </div>
                <div class="logout-btn" onclick="window.handleLogout()">ë¡œê·¸ì•„ì›ƒ</div>
            </div>

            <header>
                <h1>ëŒ€ì‹œë³´ë“œ</h1>
                <div id="current-date-text" style="color: var(--text-muted); font-size: 0.875rem;">--</div>
            </header>

            <div class="stat-card-wide">
                <span class="label">ğŸƒ í¬ë£¨ ì´ ëŸ¬ë‹ê±°ë¦¬</span>
                <div class="value"><span id="crew-total-distance">0.0</span> <span style="font-size: 1.2rem; font-weight: 600;">km</span></div>
            </div>

            <div style="margin-top: 1rem;" class="compact-stats-grid">
                <div class="stat-card-small">
                    <span class="label">ğŸ‘¥ ì´ íšŒì›ìˆ˜</span>
                    <div class="value" id="total-members-count">-- ëª…</div>
                </div>
                <div class="stat-card-small">
                    <span class="label">ğŸ“… ì˜¤ëŠ˜ ê¸°ë¡</span>
                    <div class="value" id="today-records-count">-- ê±´</div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, getDocs, addDoc } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1TE3jtcdcH6UvbfPGIy_IeaVivg2YvPA",
            authDomain: "run-app-268d5.firebaseapp.com",
            projectId: "run-app-268d5",
            storageBucket: "run-app-268d5.firebasestorage.app",
            messagingSenderId: "1064940196481",
            appId: "1:1064940196481:web:0408fd1fb557c4b2a2b380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const usersCol = collection(db, "app_users");

        let isLoginMode = true;

        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-btn').innerText = isLoginMode ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…';
            document.getElementById('auth-desc').innerText = isLoginMode ? 'ë°˜ê°‘ìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.' : 'ìƒˆë¡œìš´ í¬ë£¨ ê³„ì •ì„ ë§Œë“­ë‹ˆë‹¤.';
            document.getElementById('auth-toggle-wrapper').innerHTML = isLoginMode ? 
                'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span onclick="window.toggleAuthMode()">íšŒì›ê°€ì… í•˜ê¸°</span>' :
                'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <span onclick="window.toggleAuthMode()">ë¡œê·¸ì¸ í•˜ê¸°</span>';
        };

        window.handleAuth = async () => {
            const name = document.getElementById('auth-name').value.trim();
            const pw = document.getElementById('auth-pw').value.trim();
            if(!name || !pw) return alert('ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.');

            if (isLoginMode) {
                const q = query(usersCol, where("name", "==", name), where("password", "==", pw));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    alert('ì´ë¦„ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.');
                } else {
                    const userDoc = snapshot.docs[0].data();
                    localStorage.setItem('crew_user', JSON.stringify({ name: userDoc.name, role: userDoc.role || 'user' }));
                    checkAuth();
                }
            } else {
                const q = query(usersCol, where("name", "==", name));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) return alert('ì´ë¯¸ ìˆëŠ” ì´ë¦„ì…ë‹ˆë‹¤.');
                
                // ì²« ê°€ì…ìì´ê±°ë‚˜ íŠ¹ì • ì´ë¦„ì„ ê´€ë¦¬ìë¡œ ìë™ ì§€ì • (í…ŒìŠ¤íŠ¸ìš©: ì´ë¦„ì´ 'ê´€ë¦¬ì'ë©´ admin)
                const role = (name === 'ê´€ë¦¬ì') ? 'admin' : 'user';
                await addDoc(usersCol, { name, password: pw, role: role });
                alert(`${role === 'admin' ? 'ê´€ë¦¬ì' : 'ì¼ë°˜'} ê³„ì •ìœ¼ë¡œ ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                window.toggleAuthMode();
            }
        };

        window.handleLogout = () => {
            localStorage.removeItem('crew_user');
            location.reload();
        };

        const checkAuth = () => {
            const user = JSON.parse(localStorage.getItem('crew_user'));
            if (user) {
                document.getElementById('user-display-name').innerText = user.name;
                document.getElementById('user-role-badge').innerHTML = user.role === 'admin' ? '<span class="admin-badge">ê´€ë¦¬ì</span>' : '';
                
                // ê´€ë¦¬ìë©´ íšŒì›ê´€ë¦¬ ë©”ë‰´ ë…¸ì¶œ
                if(user.role === 'admin') {
                    document.getElementById('nav-members').style.display = 'flex';
                }

                document.getElementById('auth-section').classList.remove('active');
                document.getElementById('app-section').classList.add('active');
                initDashboard();
            } else {
                document.getElementById('auth-section').classList.add('active');
                document.getElementById('app-section').classList.remove('active');
            }
        };

        const initDashboard = () => {
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            document.getElementById('current-date-text').innerText = `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼`;

            onSnapshot(collection(db, "members"), (snapshot) => {
                document.getElementById('total-members-count').innerText = `${snapshot.size} ëª…`;
                let totalKm = 0;
                snapshot.forEach((doc) => { totalKm += (doc.data().distance || 0); });
                document.getElementById('crew-total-distance').innerText = totalKm.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1});
            });

            onSnapshot(query(collection(db, "activity_logs"), where("date", "==", todayStr)), (snapshot) => {
                document.getElementById('today-records-count').innerText = `${snapshot.size} ê±´`;
            });
        };

        checkAuth();
    </script>
</body>
</html>
